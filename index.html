<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>التزاماتي - My Obligations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        arabic: ['Noto Sans Arabic', 'sans-serif'],
                        english: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        body {
            transition: background-color 0.3s, color 0.3s;
        }
        .modal-overlay {
            background-color: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            top: -10px;
            z-index: 1000;
            animation: fall 3s linear forwards;
        }
        @keyframes fall {
            to { transform: translateY(100vh) rotate(360deg); }
        }
        .currency-symbol {
            display: inline-block;
            height: 1.1em;
            width: auto;
            vertical-align: middle;
            margin: 0 4px;
            filter: grayscale(1) opacity(0.8);
        }
        .dark .currency-symbol {
            filter: grayscale(1) invert(1) opacity(0.8);
        }

        /* Splash Screen Animation */
        #welcome-screen {
            transition: opacity 0.8s ease, visibility 0.8s;
        }
        .welcome-fade-out {
            opacity: 0;
            visibility: hidden;
        }

        /* Theme Toggle Styling */
        .theme-switch-container {
            --color: #64748b;
            --size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: pointer;
            font-size: var(--size);
            user-select: none;
            fill: var(--color);
            transition: fill 0.3s;
        }
        .dark .theme-switch-container { --color: #fbbf24; }
        .theme-switch-container .moon { position: absolute; animation: keyframes-fill .5s; }
        .theme-switch-container .sun { position: absolute; display: none; animation: keyframes-fill .5s; }
        .theme-switch-container input:checked ~ .moon { display: none; }
        .theme-switch-container input:checked ~ .sun { display: block; }
        .theme-switch-container input { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
        @keyframes keyframes-fill { 0% { transform: rotate(-360deg) scale(0); opacity: 0; } 75% { transform: rotate(25deg); } }

        /* Notif Switch Styling */
        .notif-switch-container {
            --color: #64748b;
            --size: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: pointer;
            font-size: var(--size);
            user-select: none;
            fill: var(--color);
            transition: fill 0.3s;
        }
        .dark .notif-switch-container { --color: #94a3b8; }
        .notif-switch-container .bell-regular { position: absolute; animation: keyframes-bell .5s; }
        .notif-switch-container .bell-solid { position: absolute; display: none; animation: keyframes-bell .5s; fill: #3b82f6; }
        .notif-switch-container input:checked ~ .bell-regular { display: none; }
        .notif-switch-container input:checked ~ .bell-solid { display: block; }
        .notif-switch-container input { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
        @keyframes keyframes-bell { 0% { opacity: 0; } 25% { transform: rotate(25deg); } 50% { transform: rotate(-20deg) scale(1.2); } 75% { transform: rotate(15deg); } }

        /* Loading progress bar for splash */
        .splash-progress {
            width: 240px;
            height: 6px;
            background: #e2e8f0;
            border-radius: 10px;
            margin-top: 40px;
            overflow: hidden;
            position: relative;
        }
        .splash-progress-bar {
            height: 100%;
            background: #2563eb;
            width: 0%;
            transition: width 3s linear;
        }
    </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 font-arabic overflow-x-hidden">
    <!-- Header -->
    <header class="bg-white dark:bg-slate-900 border-b dark:border-slate-800 sticky top-0 z-30 transition-colors">
        <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-10 h-10 rounded-lg overflow-hidden flex items-center justify-center bg-slate-100 dark:bg-slate-800 border dark:border-slate-700">
                    <img src="icon.png" alt="Logo" class="w-full h-full object-cover" onerror="this.onerror=null; this.src='https://www.gstatic.com/images/branding/product/1x/keep_48dp.png';">
                </div>
                <h1 id="app-title" class="text-xl font-bold tracking-tight">التزاماتي</h1>
            </div>
            
            <div class="flex items-center gap-2 md:gap-4">
                <!-- Notifications Switch Toggle -->
                <label class="notif-switch-container p-2 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors relative group" title="تفعيل التنبيهات">
                    <input type="checkbox" id="notif-checkbox" onchange="requestNotificationPermission()">
                    <svg class="bell-regular" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512">
                        <path d="M224 0c-17.7 0-32 14.3-32 32V49.9C119.5 61.4 64 124.2 64 200v33.4c0 45.4-15.5 89.5-43.8 124.9L5.3 377c-5.8 7.2-6.9 17.1-2.9 25.4S14.8 416 24 416H424c9.2 0 17.6-5.3 21.6-13.6s2.9-18.2-2.9-25.4l-14.9-18.6C399.5 322.9 384 278.8 384 233.4V200c0-75.8-55.5-138.6-128-150.1V32c0-17.7-14.3-32-32-32zm0 96h8c57.4 0 104 46.6 104 104v33.4c0 47.9 13.9 94.6 39.7 134.6H72.3C98.1 328 112 281.3 112 233.4V200c0-57.4 46.6-104 104-104h8zm64 352H224 160c0 17 6.7 33.3 18.7 45.3s28.3 18.7 45.3 18.7s33.3-6.7 45.3-18.7s18.7-28.3 18.7-45.3z" />
                    </svg>
                    <svg class="bell-solid" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512">
                        <path d="M224 0c-17.7 0-32 14.3-32 32V51.2C119 66 64 130.6 64 208v18.8c0 47-17.3 92.4-48.5 127.6l-7.4 8.3c-8.4 9.4-10.4 22.9-5.3 34.4S19.4 416 32 416H416c12.6 0 24-7.4 29.2-18.9s3.1-25-5.3-34.4l-7.4-8.3C401.3 319.2 384 273.9 384 226.8V208c0-77.4-55-142-128-156.8V32c0-17.7-14.3-32-32-32zm45.3 493.3c12-12 18.7-28.3 18.7-45.3H224 160c0 17 6.7 33.3 18.7 45.3s28.3 18.7 45.3 18.7s33.3-6.7 45.3-18.7z" />
                    </svg>
                    <span id="notif-dot" class="hidden absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full"></span>
                </label>

                <!-- Theme Toggle -->
                <label class="theme-switch-container p-2 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                    <input type="checkbox" id="theme-checkbox" onchange="toggleTheme()">
                    <svg viewBox="0 0 384 512" height="1em" xmlns="http://www.w3.org/2000/svg" class="moon"><path d="M223.5 32C100 32 0 132.3 0 256S100 480 223.5 480c60.6 0 115.5-24.2 155.8-63.4c5-4.9 6.3-12.5 3.1-18.7s-10.1-9.7-17-8.5c-9.8 1.7-19.8 2.6-30.1 2.6c-96.9 0-175.5-78.8-175.5-176c0-65.8 36-123.1 89.3-153.3c6.1-3.5 9.2-10.5 7.7-17.3s-7.3-11.9-14.3-12.5c-6.3-.5-12.6-.8-19-.8z" /></svg>
                    <svg viewBox="0 0 512 512" height="1em" xmlns="http://www.w3.org/2000/svg" class="sun"><path d="M361.5 1.2c5 2.1 8.6 6.6 9.6 11.9L391 121l107.9 19.8c5.3 1 9.8 4.6 11.9 9.6s1.5 10.7-1.6 15.2L446.9 256l62.3 90.3c3.1 4.5 3.7 10.2 1.6 15.2s-6.6 8.6-11.9 9.6L391 391 371.1 498.9c-1 5.3-4.6 9.8-9.6 11.9s-10.7 1.5-15.2-1.6L256 446.9l-90.3 62.3c-4.5 3.1-10.2 3.7-15.2 1.6s-8.6-6.6-9.6-11.9L121 391 13.1 371.1c-5.3-1-9.8-4.6-11.9-9.6s-1.5-10.7 1.6-15.2L65.1 256 2.8 165.7c-3.1-4.5-3.7-10.2-1.6-15.2s6.6-8.6 11.9-9.6L121 121 140.9 13.1c1-5.3 4.6-9.8 9.6-11.9s10.7-1.5 15.2 1.6L256 65.1 346.3 2.8c4.5-3.1 10.2-3.7 15.2-1.6zM160 256a96 96 0 1 1 192 0 96 96 0 1 1 -192 0zm224 0a128 128 0 1 0 -256 0 128 128 0 1 0 256 0z" /></svg>
                </label>

                <!-- Language Toggle -->
                <button onclick="toggleLanguage()" class="px-3 py-2 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-xs font-bold transition-colors">
                    <span id="lang-btn-text">EN</span>
                </button>

                <!-- Add Button -->
                <button onclick="toggleModal(true)" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-xl flex items-center gap-2 transition-all active:scale-95 shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                    <span class="hidden sm:inline" data-i18n="addDebt">إضافة دين</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-4 py-6">
        
        <!-- Navigation Tabs -->
        <div class="flex gap-2 mb-8 bg-white dark:bg-slate-900 p-1 rounded-2xl shadow-sm border dark:border-slate-800 w-fit transition-colors">
            <button id="tab-dashboard" onclick="switchTab('dashboard')" class="px-6 py-2 rounded-xl flex items-center gap-2 transition-all bg-blue-600 text-white shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
                <span data-i18n="dashboard">لوحة التحكم</span>
            </button>
            <button id="tab-list" onclick="switchTab('list')" class="px-6 py-2 rounded-xl flex items-center gap-2 transition-all text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h7"/><path d="M3 9h18"/><path d="M13 12v9"/></svg>
                <span data-i18n="debtList">قائمة الالتزامات</span>
            </button>
        </div>

        <!-- Dashboard Section -->
        <div id="content-dashboard">
            <!-- Salary Settings Section -->
            <div class="mb-8 bg-white dark:bg-slate-900 p-6 rounded-3xl shadow-sm border dark:border-slate-800 flex flex-col md:flex-row items-center justify-between gap-6 transition-colors">
                <div class="flex items-center gap-4">
                    <div class="bg-emerald-100 dark:bg-emerald-900/30 p-3 rounded-2xl text-emerald-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="20" height="12" x="2" y="6" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/></svg>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold" data-i18n="salaryTitle">الراتب الشهري</h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400" data-i18n="salarySub">أدخل راتبك لمعرفة المتبقي بعد الأقساط</p>
                    </div>
                </div>
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <input type="number" id="salary-input" class="w-full md:w-48 px-4 py-3 rounded-2xl border dark:border-slate-700 dark:bg-slate-800 focus:ring-2 focus:ring-blue-500 outline-none text-center font-bold" placeholder="0.00" oninput="updateSalary(this.value)">
                    <div class="bg-slate-100 dark:bg-slate-800 px-4 py-3 rounded-2xl flex items-center font-bold">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/9/98/Saudi_Riyal_Symbol.svg" class="currency-symbol h-5" alt="﷼">
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <!-- New Remaining from Salary Stat -->
                <div id="remaining-salary-card" class="bg-gradient-to-br from-emerald-500 to-teal-600 p-6 rounded-3xl shadow-lg text-white md:col-span-2 hidden animate-in zoom-in duration-300">
                    <div class="flex justify-between items-start mb-4">
                        <p class="text-emerald-50 text-sm font-medium" data-i18n="remainingSalary">المتبقي من الراتب (الصافي)</p>
                        <div class="bg-white/20 p-2 rounded-xl">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                        </div>
                    </div>
                    <p id="stat-net-salary" class="text-4xl font-bold flex items-center gap-2">0 <span class="text-xl opacity-80">﷼</span></p>
                </div>

                <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border-r-4 border-blue-500 transition-colors">
                    <p class="text-slate-500 dark:text-slate-400 text-sm mb-1" data-i18n="totalRemaining">المبلغ المتبقي الكلي</p>
                    <p id="stat-remaining" class="text-2xl font-bold flex items-center"></p>
                </div>
                <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border-r-4 border-emerald-500 transition-colors">
                    <p class="text-slate-500 dark:text-slate-400 text-sm mb-1" data-i18n="totalPaid">إجمالي ما تم سداده</p>
                    <p id="stat-paid" class="text-2xl font-bold text-emerald-600 flex items-center"></p>
                </div>
                <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border-r-4 border-amber-500 transition-colors">
                    <p class="text-slate-500 dark:text-slate-400 text-sm mb-1" data-i18n="totalMonthly">إجمالي الأقساط</p>
                    <p id="stat-monthly" class="text-2xl font-bold text-amber-600 flex items-center"></p>
                </div>
                <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border-r-4 border-indigo-500 transition-colors">
                    <p class="text-slate-500 dark:text-slate-400 text-sm mb-1" data-i18n="activeDebts">الديون النشطة</p>
                    <p id="stat-count" class="text-2xl font-bold"></p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border dark:border-slate-800 transition-colors">
                    <h3 class="text-lg font-bold mb-6" data-i18n="distribution">توزيع الديون</h3>
                    <div class="h-64 relative">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border dark:border-slate-800 transition-colors">
                    <h3 class="text-lg font-bold mb-6" data-i18n="progress">تقدم السداد</h3>
                    <div class="h-64 relative">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- List Section -->
        <div id="content-list" class="hidden">
            <div id="debt-list-container" class="grid grid-cols-1 gap-4"></div>
        </div>
    </main>

    <!-- Modal Form -->
    <div id="debt-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white dark:bg-slate-900 w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden transition-colors">
            <div class="p-6 border-b dark:border-slate-800 flex justify-between items-center bg-blue-600 text-white">
                <h2 class="text-xl font-bold" data-i18n="modalTitle">إضافة التزام جديد</h2>
                <button onclick="toggleModal(false)" class="hover:bg-white/20 p-1 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <form id="debt-form" class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1" data-i18n="labelName">اسم الدين / الغرض</label>
                        <input id="f-name" required type="text" class="w-full px-4 py-3 rounded-xl border dark:border-slate-700 dark:bg-slate-800 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1" data-i18n="labelAmount">المبلغ الإجمالي</label>
                        <input id="f-amount" required type="number" placeholder="0.00"step="any" class="w-full px-4 py-3 rounded-xl border dark:border-slate-700 dark:bg-slate-800 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1" data-i18n="labelDuration">المدة (أشهر)</label>
                        <input id="f-duration" required type="number" placeholder="0"class="w-full px-4 py-3 rounded-xl border dark:border-slate-700 dark:bg-slate-800 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1" data-i18n="labelDay">يوم السداد الشهري</label>
                        <input id="f-repaymentDay" required type="number" min="1" max="31" placeholder="0" class="w-full px-4 py-3 rounded-xl border dark:border-slate-700 dark:bg-slate-800 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1" data-i18n="labelCategory">التصنيف</label>
                        <select id="f-category" class="w-full px-4 py-3 rounded-xl border dark:border-slate-700 dark:bg-slate-800 focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="Personal">سلفة شخصية</option>
                            <option value="Savings">جمعية </option>
                            <option value="Installments">أقساط مشتريات</option>
                            <option value="Bank">قرض بنكي</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1" data-i18n="labelDate">تاريخ البدء</label>
                        <input id="f-startDate" type="date" class="w-full px-4 py-3 rounded-xl border dark:border-slate-700 dark:bg-slate-800 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
                <div class="pt-4 flex gap-3">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition-all" data-i18n="btnSave">حفظ الدين</button>
                    <button type="button" onclick="toggleModal(false)" class="px-6 py-3 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-xl hover:bg-slate-200 dark:hover:bg-slate-700 transition-all" data-i18n="btnCancel">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Celebration Modal -->
    <div id="celebration-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white dark:bg-slate-900 w-full max-w-sm rounded-3xl shadow-2xl overflow-hidden p-8 text-center animate-in zoom-in duration-300 transition-colors">
            <div class="w-20 h-20 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
            </div>
            <h2 class="text-2xl font-bold mb-2" data-i18n="congrats">مبارك لك!</h2>
            <p id="celebration-text" class="text-slate-600 dark:text-slate-400 mb-6"></p>
            <button onclick="closeCelebration()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-xl transition-all" data-i18n="continue">استمرار</button>
        </div>
    </div>

    <script>
        // Translations
        const i18n = {
            ar: {
                title: "التزاماتي",
                welcomeSub: "نظم ديونك، تتبع دفعاتك، وحقق حريتك المالية بكل سهولة ووضوح.",
                addDebt: "إضافة دين",
                dashboard: "لوحة التحكم",
                debtList: "قائمة الالتزامات",
                totalRemaining: "المبلغ المتبقي الكلي",
                totalPaid: "إجمالي ما تم سداده",
                totalMonthly: "إجمالي الأقساط",
                activeDebts: "الالتزامات النشطة",
                distribution: "توزيع الديون",
                progress: "تقدم السداد",
                modalTitle: "إضافة التزام جديد",
                labelName: "اسم الدين / الغرض",
                labelAmount: "المبلغ الإجمالي",
                labelDuration: "المدة (أشهر)",
                labelDay: "يوم السداد الشهري",
                labelCategory: "التصنيف",
                labelDate: "تاريخ البدء",
                btnSave: "حفظ الدين",
                btnCancel: "إلغاء",
                congrats: "مبارك لك!",
                continue: "استمرار",
                paidStatus: "تم السداد",
                payDay: "يوم",
                startAt: "بدأ في",
                settleAll: "سداد كامل",
                track: "تتبع الدفعات",
                month: "شهر",
                installment: "القسط",
                due: "المستحق",
                paid: "المسدد",
                action: "الإجراء",
                langBtn: "EN",
                cats: { Personal: "سلفة شخصية", Savings: "جمعية شهرية", Installments: "أقساط مشتريات", Bank: "قرض بنكي", Other: "آخر" },
                notifTitle: "تذكير بالسداد",
                notifMsg: "لديك موعد سداد اليوم للالتزام: ",
                notifEnabled: "تم تفعيل التنبيهات بنجاح",
                salaryTitle: "الراتب الشهري",
                salarySub: "أدخل راتبك لمعرفة المتبقي بعد الأقساط",
                remainingSalary: "المتبقي من الراتب (الصافي)"
            },
            en: {
                title: "My Obligations",
                welcomeSub: "Organize your debts, track payments, and achieve financial freedom with clarity.",
                addDebt: "Add Debt",
                dashboard: "Dashboard",
                debtList: "Obligations List",
                totalRemaining: "Total Remaining",
                totalPaid: "Total Paid",
                totalMonthly: "Total Installments",
                activeDebts: "Active Debts",
                distribution: "Distribution",
                progress: "Payment Progress",
                modalTitle: "Add New Obligation",
                labelName: "Debt Name / Purpose",
                labelAmount: "Total Amount",
                labelDuration: "Duration (Months)",
                labelDay: "Repayment Day",
                labelCategory: "Category",
                labelDate: "Start Date",
                btnSave: "Save Debt",
                btnCancel: "Cancel",
                congrats: "Congratulations!",
                continue: "Continue",
                paidStatus: "Paid",
                payDay: "Day",
                startAt: "Started at",
                settleAll: "Settle All",
                track: "Track Payments",
                month: "Mo.",
                installment: "Installment",
                due: "Due",
                paid: "Paid",
                action: "Action",
                langBtn: "AR",
                cats: { Personal: "Personal Loan", Savings: "Monthly Savings", Installments: "Installments", Bank: "Bank Loan", Other: "Other" },
                notifTitle: "Payment Reminder",
                notifMsg: "You have a payment due today for: ",
                notifEnabled: "Notifications enabled successfully",
                salaryTitle: "Monthly Salary",
                salarySub: "Enter your salary to see net amount after installments",
                remainingSalary: "Remaining Salary (Net)"
            }
        };

        const RIYAL_ICON = `<img src="https://upload.wikimedia.org/wikipedia/commons/9/98/Saudi_Riyal_Symbol.svg" class="currency-symbol" alt="﷼">`;
        let debts = JSON.parse(localStorage.getItem('obligations_data') || '[]');
        let currentSalary = parseFloat(localStorage.getItem('user_salary') || '0');
        let currentLang = localStorage.getItem('lang') || 'ar';
        let currentTheme = localStorage.getItem('theme') || 'light';
        let activeTab = 'dashboard';
        let pieChart, barChart;
        let splashTimeout;

        function init() {
            document.documentElement.className = currentTheme;
            document.documentElement.lang = currentLang;
            document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            document.body.className = `min-h-screen bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 transition-colors ${currentLang === 'ar' ? 'font-arabic' : 'font-english'}`;
            
            document.getElementById('theme-checkbox').checked = (currentTheme === 'light');
            document.getElementById('salary-input').value = currentSalary > 0 ? currentSalary : '';
            
            const notifPref = localStorage.getItem('notif_enabled') === 'true';
            const checkbox = document.getElementById('notif-checkbox');
            
            if (Notification.permission === 'granted' && notifPref) {
                checkbox.checked = true;
                document.getElementById('notif-dot').classList.remove('hidden');
                checkDuePayments();
            }

            updateTranslations();
            renderDashboard();
            document.getElementById('f-startDate').valueAsDate = new Date();

            if (sessionStorage.getItem('welcome_seen')) {
                document.getElementById('welcome-screen').style.display = 'none';
            } else {
                document.getElementById('splash-bar').style.width = '100%';
                splashTimeout = setTimeout(hideWelcome, 3500); 
            }
        }

        function hideWelcome() {
            if (splashTimeout) clearTimeout(splashTimeout);
            const screen = document.getElementById('welcome-screen');
            screen.classList.add('welcome-fade-out');
            sessionStorage.setItem('welcome_seen', 'true');
            setTimeout(() => { screen.style.display = 'none'; }, 800);
        }

        function updateSalary(val) {
            currentSalary = parseFloat(val) || 0;
            localStorage.setItem('user_salary', currentSalary);
            renderDashboard();
        }

        function requestNotificationPermission() {
            const checkbox = document.getElementById('notif-checkbox');
            const t = i18n[currentLang];
            if (!("Notification" in window)) { checkbox.checked = false; return; }
            if (checkbox.checked) {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        localStorage.setItem('notif_enabled', 'true');
                        document.getElementById('notif-dot').classList.remove('hidden');
                        new Notification(t.notifTitle, { body: t.notifEnabled });
                        checkDuePayments();
                    } else { checkbox.checked = false; }
                });
            } else {
                localStorage.setItem('notif_enabled', 'false');
                document.getElementById('notif-dot').classList.add('hidden');
            }
        }

        function checkDuePayments() {
            const notifPref = localStorage.getItem('notif_enabled') === 'true';
            if (Notification.permission !== 'granted' || !notifPref) return;
            const today = new Date();
            const currentDay = today.getDate();
            const dateKey = `${today.getFullYear()}-${today.getMonth()}-${currentDay}`;
            const lastNotified = localStorage.getItem('last_notified_date');
            if (lastNotified === dateKey) return;
            const t = i18n[currentLang];
            let notifiedCount = 0;
            debts.forEach(debt => {
                if (debt.status === 'active' && parseInt(debt.repaymentDay) === currentDay) {
                    new Notification(t.notifTitle, { body: `${t.notifMsg} ${debt.name}`, icon: 'icon.png' });
                    notifiedCount++;
                }
            });
            if (notifiedCount > 0) localStorage.setItem('last_notified_date', dateKey);
        }

        function toggleTheme() {
            const isLight = document.getElementById('theme-checkbox').checked;
            currentTheme = isLight ? 'light' : 'dark';
            localStorage.setItem('theme', currentTheme);
            document.documentElement.className = currentTheme;
            if (activeTab === 'dashboard') renderDashboard();
        }

        function toggleLanguage() {
            currentLang = currentLang === 'ar' ? 'en' : 'ar';
            localStorage.setItem('lang', currentLang);
            document.documentElement.lang = currentLang;
            document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            document.body.className = `min-h-screen bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 transition-colors ${currentLang === 'ar' ? 'font-arabic' : 'font-english'}`;
            updateTranslations();
            if (activeTab === 'dashboard') renderDashboard();
            else renderDebtList();
        }

        function updateTranslations() {
            const t = i18n[currentLang];
            document.getElementById('app-title').textContent = t.title;
            document.getElementById('lang-btn-text').textContent = t.langBtn;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.textContent = t[key];
            });
            const catSelect = document.getElementById('f-category');
            Array.from(catSelect.options).forEach(opt => { opt.textContent = t.cats[opt.value]; });
        }

        function toggleModal(show) {
            document.getElementById('debt-modal').classList.toggle('hidden', !show);
            if(show) document.getElementById('debt-form').reset();
        }

        function switchTab(tab) {
            activeTab = tab;
            document.getElementById('content-dashboard').classList.toggle('hidden', tab !== 'dashboard');
            document.getElementById('content-list').classList.toggle('hidden', tab !== 'list');
            const btnDash = document.getElementById('tab-dashboard');
            const btnList = document.getElementById('tab-list');
            const activeClass = "px-6 py-2 rounded-xl flex items-center gap-2 transition-all bg-blue-600 text-white shadow-md";
            const inactiveClass = "px-6 py-2 rounded-xl flex items-center gap-2 transition-all text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800";
            btnDash.className = tab === 'dashboard' ? activeClass : inactiveClass;
            btnList.className = tab === 'list' ? activeClass : inactiveClass;
            if (tab === 'dashboard') renderDashboard();
            else renderDebtList();
        }

        function calculateDebtDetails(debt) {
            const P = parseFloat(debt.amount);
            const n = parseInt(debt.duration);
            const monthlyInstallment = P / n;
            const schedule = [];
            let remaining = P;
            for (let i = 1; i <= n; i++) {
                remaining -= monthlyInstallment;
                schedule.push({ month: i, payment: monthlyInstallment.toFixed(2), balance: Math.max(0, remaining).toFixed(2) });
            }
            return { ...debt, monthlyInstallment: monthlyInstallment.toFixed(2), totalPaidTheoretical: P.toFixed(2), schedule, payments: debt.payments || {} };
        }

        document.getElementById('debt-form').onsubmit = function(e) {
            e.preventDefault();
            const newDebt = calculateDebtDetails({
                id: Date.now(),
                name: document.getElementById('f-name').value,
                amount: document.getElementById('f-amount').value,
                duration: document.getElementById('f-duration').value,
                repaymentDay: document.getElementById('f-repaymentDay').value,
                category: document.getElementById('f-category').value,
                startDate: document.getElementById('f-startDate').value,
                status: 'active',
                payments: {}
            });
            debts.push(newDebt);
            saveData();
            toggleModal(false);
        };

        function saveData() {
            localStorage.setItem('obligations_data', JSON.stringify(debts));
            if (activeTab === 'dashboard') renderDashboard();
            else renderDebtList();
        }

        function deleteDebt(id) { debts = debts.filter(d => d.id !== id); saveData(); }

        function toggleStatus(id) {
            debts = debts.map(d => {
                if(d.id === id) {
                    const newStatus = d.status === 'active' ? 'paid' : 'active';
                    if(newStatus === 'paid') showCelebration(d.name);
                    return {...d, status: newStatus};
                }
                return d;
            });
            saveData();
        }

        function updatePayment(debtId, month, amount) {
            debts = debts.map(d => {
                if (d.id === debtId) {
                    const payments = {...d.payments, [month]: parseFloat(amount) || 0};
                    const totalActualPaid = Object.values(payments).reduce((a, b) => a + b, 0);
                    const updated = {...d, payments};
                    if (totalActualPaid >= parseFloat(d.totalPaidTheoretical) - 0.1 && d.status === 'active') {
                        updated.status = 'paid';
                        showCelebration(d.name);
                    }
                    return updated;
                }
                return d;
            });
            saveData();
        }

        function settleAll(id) {
            debts = debts.map(d => {
                if (d.id === id) {
                    const payments = {};
                    d.schedule.forEach(i => payments[i.month] = parseFloat(i.payment));
                    showCelebration(d.name);
                    return { ...d, payments, status: 'paid' };
                }
                return d;
            });
            saveData();
        }

        function showCelebration(name) {
            document.getElementById('celebration-text').innerHTML = currentLang === 'ar' 
                ? `لقد أتممت سداد <b>"${name}"</b> بنجاح. أنت الآن أقرب للحرية المالية!`
                : `You successfully paid off <b>"${name}"</b>. You're closer to financial freedom!`;
            document.getElementById('celebration-modal').classList.remove('hidden');
            createConfetti();
        }

        function closeCelebration() { document.getElementById('celebration-modal').classList.add('hidden'); }

        function createConfetti() {
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
            for (let i = 0; i < 80; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random() * 100 + 'vw';
                c.style.backgroundColor = colors[Math.floor(Math.random() * 5)];
                c.style.animationDelay = Math.random() * 2 + 's';
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 3000);
            }
        }

        function getActualPaid(debt) { return Object.values(debt.payments).reduce((a, b) => a + b, 0); }

        function renderDashboard() {
            const active = debts.filter(d => d.status === 'active');
            let totalRemaining = 0, totalPaid = 0, totalMonthly = 0;
            debts.forEach(d => {
                const paid = getActualPaid(d);
                totalPaid += paid;
                if (d.status === 'active') {
                    totalRemaining += (parseFloat(d.totalPaidTheoretical) - paid);
                    totalMonthly += parseFloat(d.monthlyInstallment);
                }
            });

            // Update Basic Stats
            document.getElementById('stat-remaining').innerHTML = totalRemaining.toLocaleString() + RIYAL_ICON;
            document.getElementById('stat-paid').innerHTML = totalPaid.toLocaleString() + RIYAL_ICON;
            document.getElementById('stat-monthly').innerHTML = totalMonthly.toLocaleString() + RIYAL_ICON;
            document.getElementById('stat-count').textContent = active.length;

            // Handle Salary Logic
            const netSalaryCard = document.getElementById('remaining-salary-card');
            if (currentSalary > 0) {
                netSalaryCard.classList.remove('hidden');
                const netAmount = currentSalary - totalMonthly;
                document.getElementById('stat-net-salary').innerHTML = netAmount.toLocaleString() + ' <span class="text-xl opacity-80">﷼</span>';
            } else {
                netSalaryCard.classList.add('hidden');
            }

            renderCharts(active);
        }

        function renderCharts(active) {
            if (pieChart) pieChart.destroy();
            if (barChart) barChart.destroy();
            if (active.length === 0) return;
            const isDark = currentTheme === 'dark';
            const textColor = isDark ? '#94a3b8' : '#64748b';
            const ctxPie = document.getElementById('pieChart').getContext('2d');
            pieChart = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: active.map(d => d.name),
                    datasets: [{
                        data: active.map(d => parseFloat(d.amount)),
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
                        borderWidth: 0
                    }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { labels: { color: textColor } } } }
            });
            const ctxBar = document.getElementById('barChart').getContext('2d');
            barChart = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: active.map(d => d.name),
                    datasets: [
                        { label: i18n[currentLang].paid, data: active.map(d => getActualPaid(d)), backgroundColor: '#10b981' },
                        { label: i18n[currentLang].due, data: active.map(d => parseFloat(d.amount)), backgroundColor: isDark ? '#1e293b' : '#e2e8f0' }
                    ]
                },
                options: { 
                    maintainAspectRatio: false,
                    scales: { 
                        y: { beginAtZero: true, grid: { color: isDark ? '#334155' : '#f1f5f9' }, ticks: { color: textColor } },
                        x: { grid: { display: false }, ticks: { color: textColor } }
                    },
                    plugins: { legend: { labels: { color: textColor } } }
                }
            });
        }

        function renderDebtList() {
            const container = document.getElementById('debt-list-container');
            container.innerHTML = '';
            const t = i18n[currentLang];
            debts.forEach(debt => {
                const actualPaid = getActualPaid(debt);
                const totalDue = parseFloat(debt.totalPaidTheoretical);
                const progress = (actualPaid / totalDue) * 100;
                const isPaid = debt.status === 'paid';
                const card = document.createElement('div');
                card.className = `bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-2xl overflow-hidden shadow-sm transition-all ${isPaid ? 'opacity-70 grayscale' : ''}`;
                card.innerHTML = `
                    <div class="p-5">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <div class="flex flex-wrap gap-2 mb-1">
                                    <span class="text-[10px] font-bold text-blue-600 bg-blue-50 dark:bg-blue-900/30 px-2 py-1 rounded-full">${t.cats[debt.category]}</span>
                                    <span class="text-[10px] font-bold text-amber-600 bg-amber-50 dark:bg-amber-900/30 px-2 py-1 rounded-full flex items-center gap-1">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                        ${t.payDay} ${debt.repaymentDay}
                                    </span>
                                    ${isPaid ? `<span class="text-[10px] font-bold text-emerald-600 bg-emerald-50 dark:bg-emerald-900/30 px-2 py-1 rounded-full">${t.paidStatus}</span>` : ''}
                                </div>
                                <h3 class="text-lg font-bold">${debt.name}</h3>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="toggleStatus(${debt.id})" class="p-2 bg-slate-100 dark:bg-slate-800 rounded-lg hover:text-emerald-600"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 4 12 14 9 11"/></svg></button>
                                <button onclick="deleteDebt(${debt.id})" class="p-2 bg-slate-100 dark:bg-slate-800 rounded-lg hover:text-red-600"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18m-2 0v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></button>
                            </div>
                        </div>
                        <div class="mb-4">
                            <div class="flex justify-between text-xs mb-1 font-bold"><span class="text-slate-500">${t.progress}</span><span class="text-emerald-600">${progress.toFixed(1)}%</span></div>
                            <div class="w-full h-1.5 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden"><div class="h-full bg-emerald-500 transition-all duration-1000" style="width: ${Math.min(100, progress)}%"></div></div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div><p class="text-slate-400 text-[10px] uppercase font-bold tracking-wider">${t.labelAmount}</p><p class="font-bold flex items-center">${parseFloat(debt.amount).toLocaleString()} ${RIYAL_ICON}</p></div>
                            <div><p class="text-slate-400 text-[10px] uppercase font-bold tracking-wider">${t.paid}</p><p class="font-bold text-emerald-600 flex items-center">${actualPaid.toLocaleString()} ${RIYAL_ICON}</p></div>
                            <div><p class="text-slate-400 text-[10px] uppercase font-bold tracking-wider">${t.totalRemaining}</p><p class="font-bold text-blue-600 flex items-center">${Math.max(0, totalDue - actualPaid).toLocaleString()} ${RIYAL_ICON}</p></div>
                            <div><p class="text-slate-400 text-[10px] uppercase font-bold tracking-wider">${t.installment}</p><p class="font-bold text-amber-600 flex items-center">${parseFloat(debt.monthlyInstallment).toLocaleString()} ${RIYAL_ICON}</p></div>
                        </div>
                    </div>
                    <div class="bg-slate-50 dark:bg-slate-800/50 p-3 border-t dark:border-slate-800 flex justify-between items-center">
                        <span class="text-[10px] text-slate-500 font-bold uppercase">${t.startAt}: ${debt.startDate}</span>
                        <div class="flex gap-2">
                            ${!isPaid ? `<button onclick="settleAll(${debt.id})" class="text-emerald-600 text-[10px] font-bold hover:bg-emerald-50 dark:hover:bg-emerald-900/20 px-3 py-1.5 rounded-lg border border-emerald-100 dark:border-emerald-900/30">${t.settleAll}</button>` : ''}
                            <button onclick="toggleDetails(${debt.id})" class="text-blue-600 text-[10px] font-bold hover:underline px-3 py-1.5 rounded-lg">${t.track}</button>
                        </div>
                    </div>
                    <div id="details-${debt.id}" class="hidden p-4 border-t dark:border-slate-800 bg-white dark:bg-slate-900 overflow-x-auto">
                        <table class="w-full text-[11px] text-right">
                            <thead>
                                <tr class="border-b dark:border-slate-800 text-slate-400">
                                    <th class="py-2">${t.month}</th><th class="py-2 text-center">${t.due}</th><th class="py-2 text-center">${t.paid}</th><th class="py-2 text-center">${t.action}</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y dark:divide-slate-800">
                                ${debt.schedule.map(item => `
                                    <tr>
                                        <td class="py-2 font-bold text-slate-400">#${item.month}</td><td class="py-2 text-center">${item.payment}</td><td class="py-2 text-center font-bold text-emerald-600">${(debt.payments[item.month] || 0).toLocaleString()}</td>
                                        <td class="py-2 text-center flex justify-center gap-1">
                                            <input type="number" step="any" class="w-16 border dark:border-slate-700 dark:bg-slate-800 rounded text-center px-1" value="${debt.payments[item.month] || ''}" onchange="updatePayment(${debt.id}, ${item.month}, this.value)">
                                            <button onclick="updatePayment(${debt.id}, ${item.month}, ${item.payment})" class="p-1 bg-blue-50 dark:bg-blue-900/30 text-blue-600 rounded"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg></button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function toggleDetails(id) { document.getElementById(`details-${id}`).classList.toggle('hidden'); }
        window.onload = init;
    </script>
</body>
</html>
